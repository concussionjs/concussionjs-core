var mongoose = require('mongoose');
url = require("url")
path = require("path")
http = require("http")
fs = require("fs")
var html = fs.readFileSync("kotemplate.ejs","utf-8");
var ejs = require("ejs");
var parse = require('../../testParse.js');
var koScript = "";
module.exports.koScript=koScript;

var db = mongoose.connect('mongodb://localhost/test');
Schema = mongoose.Schema;
var appLocation;
var appSchema = new Schema();
var mySchema = new Schema();


appSchema.add({
port: Number,
location: String,
name: String,
fields:[]
});

var apps = mongoose.model("apps",appSchema);

module.exports.listen = function (server,id) {
	console.log("the id:" + id);
	var instance = new apps();
	var port;
	apps.findById(id,function(err,doc){	
		server.listen(doc.port);
		appLocation=doc.location;
		console.log("after server.address().port: " + server.address().port);
	});
}


module.exports.createServer = function(settings,createserver)
{
	var server = http.createServer(function(req,res){
		createserver(req,res);
	});
	listen(server,settings.id);
}

module.exports.createServerWithStaticFiles = function(settings,createserver)
{
        var server = http.createServer(function(req,res){
                serveStaticFiles(req,res,createserver);
        });
        listen(server,settings.id);
}

/*addNewObjects = function(objects,callback)
{
	console.log("inside addNewObjects");
	mySchema.add({"fields":[]});
	mySchema.add({"name":String});
	var myObject = mongoose.model("nextera_objects",mySchema);
	var newObject = new myObject();
	for(i=0;i<objects.length;i++)
	{
		
		try{
		var currentObj = objects[i];
		console.log(currentObj.fields.length, JSON.stringify(currentObj));	
		myObject.find({"name":objects[i].name},function(err,result)
		{
			console.log("inside find");
			if(err)
			{
				console.log(err);
				return;
			}
			
			if(result.length>0)
			{
				console.log("update object ",result);
				callback();
				return;
			}
			
			console.log("add object ", objects[i].name);
			//setupObject(currentObj,function(obj2add){
				console.log("test",JSON.stringify(currentObj));
				newObject.name = currentObj.name;
				newObject.fields = currentObj.fields;
				newObject.save(newObject,function(err){
						if(err)
						{
							console.log(err);
						}
						console.log("successfuly added");
						callback();	
				});
			//});
				
		});
		}catch(e){console.log("big error",e);}
	}
	
}*/
module.exports.serveStaticFilesNoWriteHead = function(req,res,next){
              
		var uri = url.parse(req.url).pathname.split("?")[0];
              	
		var dirname = appLocation;//path.dirname(process.cwd());
		console.log(dirname," ",uri);
		var filename = path.join(dirname,uri);		
		       
		path.exists(filename, function(exists) {               	
			if(!exists) 
			{
                        	//res.writeHead(404, {"Content-Type": "text/plain"});
                        	//res.write("404 Not Found\n");
                        	//res.end();
				console.log(filename + " does not exist");
				next();
				return;                       	
                	}

                	if (fs.statSync(filename).isDirectory())
			{
				filename += "/index.html";
			}

                	fs.readFile(filename, "binary", function(err, file) 
			{

                		if(err) 
				{
	                        	res.write(err + "\n");
        	                	res.end();
					next();
                	        	return;
              			}
				console.log("about to write head, filename: ",filename, " ", filename.search("index.html") );
				res.writeHead(200);
				if(filename.search(".html")>-1)
				{
										
					var noSchema = new Schema({
						name: String,
						fields:[]
					});

					var myModel = mongoose.model("nextera_object",noSchema);
					myModel.find({},function(err,objects){
					//parse.runGenerateStructure(filename,function(objects){
						fs.writeFileSync("./output.txt",JSON.stringify(objects),"utf8");		
						console.log("look at pee ",JSON.stringify(objects));
						//JSON.parse(objects)					
						console.log(ejs.render(html,{locals:{myObjects:objects}}));
						res.write(ejs.render(html,{locals:{myObjects:objects}}));
						res.write(koScript);
                		res.write(file, "binary");
		              	res.end();
		              	//addNewObjects(objects);	
					});
				}
				else
				{
					res.write(file, "binary");
		              	res.end();
				}
			});
			return true;
		});
}

