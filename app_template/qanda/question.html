<!DOCTYPE html>
<html>
<head>
	<title>Question</title>
	<meta charset="utf-8">
	<script type="text/javascript" src="js/leaguegothic.js"></script>
	<!--script type="text/javascript">try{Typekit.load();}catch(e){}</script-->
<script src="http://code.jquery.com/jquery-latest.js"></script>
     	<script language="JavaScript" src="http://cloud.github.com/downloads/SteveSanderson/knockout/knockout-2.0.0.js"></script>
	<script>
 	$(function() {
		var rootNode;
		function Tag(data) {
			var self=this;
			//alert(data.name);
			this.name=data.name;
		}
		
		function Answer(data) {
			var self=this;
			if(!data)
				return;
			self.answer=ko.observable(data.answer);
			self.votes=ko.observable(data.votes);
			self.voteUp = function(){
				//alert(self.votes());
				self.votes(self.votes()+1);
				//alert(self.votes());
				self.save();
			}

			self.voteDown=function(){
				self.votes(self.votes()-1);
				self.save();
			}

			myId=getUrlVars()["id"];
			//alert(ko.toJSON(self));
			self.save = function() {
        			$.ajax("/saveQuestions?id="+myId, {
            				data: ko.toJSON(rootNode.questions()[0].answers),
            				type: "post", contentType: "application/json",
            				success: function(result) 
						{ 
						}
        			});
    			};

		}

	
		function Question(data) {
    			var self = this;
    			self.id = ko.observable(data._id);
			self.title = ko.observable(data.title);
   			self.text = ko.observable(data.text);
			self.answerCount = ko.observable();
			self.metaTitle = ko.observable();
			self.myAnswer = ko.observable(); 
			self.answers = ko.observableArray([]);
			self.tags = ko.observableArray([]);
			if(data.votes)
			{
    				self.votes = ko.observable(data.votes);
			}
			else
			{	
				self.votes = 0;
			}
			if(data.tags){
				self.tags = data.tags;
			}
			else
			{
				self.tags = [];
			}

			this.metaTitle("<a href='question.html?id=" + data._id +"'>" + data.title + "</a>");
			if(data.answers)
			{
				self.answers=[];
				self.answers = $.map(data.answers,function(item){return new Answer(item)});
				//alert(this.answers.length);
				self.answerCount = this.answers.length;
				self.answers.sort(function(left, right) { return left.votes() == right.votes() ? 0 : (left.votes() < right.votes() ? 1 : -1) });
			}
			else
			{
				self.answers=[];
			}
			
			
			
			
		}

		function QuestionListViewModel() {
    			// Data
    			var self = this;
			rootNode = self;
    			self.questions = ko.observableArray([]);
			self.searchTerm=ko.observable();

			myId=getUrlVars()["id"];
			
			$.getJSON("/questions?id="+myId, function(allData) {
        			var mappedQuestions = $.map(allData, function(item) { return new Question(item) });
        			self.questions(mappedQuestions);				
    			});
	
			self.addAnswer = function() {
                        	self.questions()[0].answers.push(new Answer({ answer: self.questions()[0].myAnswer(),votes:0 }));
   				self.save();
				self.questions()[0].myAnswer("");
                	};
			
			self.save = function() {
        			$.ajax("/saveQuestions?id="+myId, {
            				data: ko.toJSON(self.questions()[0].answers),
            				type: "post", contentType: "application/json",
            				success: function(result) 
						{ 
							$.getJSON("http://demoqanda.nextera.com/questions?id="+myId, function(allData) {
        							var mappedQuestions = $.map(allData, function(item) { return new Question(item) });
        							self.questions(mappedQuestions);			
    							});
						}
        			});
    			};

			runSearch = function()
			{
				location = "/index.html?searchTerm=" + self.searchTerm(); 
			};

			
		}

		ko.applyBindings(new QuestionListViewModel());

	});

	function getUrlVars() {
		var vars = {};
		var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
			vars[key] = value;
		});
		return vars;
	}

	</script>

	<link rel="stylesheet" href="css/main.css">
	<link rel="icon" href="images/favicon.png">
</head>
<body>

	<header id="global-header">
		<div id="global-header-layout">
			<h1><a href="index.html">Answers</a></h1>
			<div id="search"><input type="search" name="search" id="search-input" placeholder="Search for an answer" autofocus list="search-results" data-bind="value:searchTerm, valueUpdate: 'afterkeydown',event:{keyup:runSearch}"></div>
			<div id="question"><a href="javascript:;" id="question-button">Ask a Question</a></div>
		</div>
	</header>

	<span id="theRoot" data-bind="foreach: questions">
	<section id="main" >
		
		<article>
			<div class="hbox">
				<div class="count-box"> <span data-bind="text:answerCount">2</span> answers</div>
				<div class="text-box">
					<h3 data-bind="html:metaTitle"><a href="javascript:;">What does it feel like to work for the president of the United States?</a></h3>
				</div>
			</div>
			<div class="hbox">
				<div class="count-box"></div>
				<div class="text-box" data-bind="foreach:tags">
        				<a href="#" class="tag" data-bind="text:$data">History</a>
				</div>
			</div>
		</article>

		<div data-bind="foreach:answers">
		<article>
			<div class="hbox">
				<div class="count-box">
					<span data-bind="text:votes"></span> votes
					<div class="vote-buttons"><img data-bind="click: voteUp" src="images/vote-up.png" width=18px height=11px ><img data-bind="click: voteDown" src="images/vote-down.png" width="18px" height="11px"></div>
				</div>
				<div class="text-box" data-bind="html:answer">
					<p>It probably helps to start this by answering: how does the White House work? I'm not sure people have a good understanding of that to begin with, and it drives the question above. Disclaimer: This is a very simplified view of a complex organization.
					<p>It probably helps to start this by answering: how does the White House work? I'm not sure people have a good understanding of that to begin with, and it drives the question above. Disclaimer: This is a very simplified view of a complex organization.
				</div>
			</div>
		</article>
		</div>
		
		<form data-bind="submit:$parent.addAnswer">
			<input name="id" type="hidden" data-bind="value:id"/>
			<div class="add-answer">
				<h2>Enter an Answer</h2>
				<table class="form">
					<tbody>
						<tr>
							<th><label for="answer">I think:</label></th>
							<td>
								<textarea id="answer" data-bind="value:myAnswer"></textarea>
							</td>
						</tr>
						<tr>
							<th></th>
							<td><button type="submit">Submit Answer</button></td>
						</tr>
					</tbody>
				</table>
			</div>
		</form>
	</section>
	</span>
</body>
</html>
